<!doctype html>
<html>
  <head>
    <title>Otto</title>

    <link rel="stylesheet" media="all" href="styles/main.css">

    <script class="wrapper" type="text/x-handlebars-template">

      <!-- 1. Activities -->
      <section class="activity">
        <h3>Activities</h3>
        <ul class="list">
          {{#each activity}}
            <li class="item" data-count="{{ @index }}">
              <a href="#" onclick="toggleDetails('activity', {{ @key }})">
                {{ name }}
              </a>
              <div class="details">
                <ul>
                  <li class="field"><strong>At home?</strong> {{ atHome }}</li>
                  <li class="field"><strong>Do we have to pay?</strong> {{ requiresPaying }}</li>
                </ul>
                <a href="#" onclick="dismiss()" class="dismiss">×</a>
              </div>
            </li>
          {{/each}}
        </ul>
    	</section>

      <!-- 2. Trips -->
      <section class="trip">
        <h3>Trips</h3>
        <ul class="list">
          {{#each trip}}
            <li class="item" data-count="{{ @index }}">
              <a href="#" onclick="toggleDetails('trip', {{ @key }})">
                {{ name }}
              </a>
              <div class="details">
                <ul>
                  <li class="field"><strong>Location</strong> {{ location }}</li>
                  <li class="field"><strong>isRelatedToWhichActivity</strong> (to-do)</li>
                </ul>
                <a href="#" onclick="dismiss()" class="dismiss">×</a>
              </div>
            </li>
          {{/each}}
        </ul>
    	</section>

      <!-- 3. Restaurants -->
      <section class="restaurant">
        <h3>Restaurants</h3>
        <ul class="list">
          {{#each restaurant}}
            <li class="item" data-count="{{ @index }}">
              <a href="#" onclick="toggleDetails('restaurant', {{ @key }})">
                {{ name }}
              </a>
              <div class="details">
                <ul>
                  <li class="field"><strong>Been there yet?</strong> {{ beenThere }}</li>
                  <li class="field"><strong>type</strong> (to-do)</li>
                </ul>
                <a href="#" onclick="dismiss()" class="dismiss">×</a>
              </div>
            </li>
          {{/each}}
        </ul>
    	</section>

      <!-- 4. TV -->
      <section class="tv">
        <h3>TV</h3>
        <ul class="list">
          {{#each tv}}
            <li class="item" data-count="{{ @index }}">
              <a href="#" onclick="toggleDetails('tv', {{ @key }})">
                {{ name }}
              </a>
              <div class="details">
                <ul>
                  <li class="field"><strong>Trailer</strong> {{ trailer }}</li>
                  <li class="field"><strong>Type</strong> {{ type }}</li>
                </ul>
                <a href="#" onclick="dismiss()" class="dismiss">×</a>
              </div>
            </li>
          {{/each}}
        </ul>
    	</section>
    </script>

  </head>

  <body>

    <div class="container"></div>

    <script src="https://npmcdn.com/contentful@3.5.0/browser-dist/contentful.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>

    <script>

      /**
       * Toggling details
       */

      var toggleDetails = function(content_type, key) {
        if (document.querySelector('.visible')) dismiss();

        // Show respective details
        var respectiveDetails = '.' + content_type + ' .item[data-count="' + key +'"]' + ' .details';
        document.querySelector(respectiveDetails).className += ' visible';
      };

      var dismiss = function() {
        document.querySelector('.visible').className = 'details';
      };

      /**
       * Hook up to Contentful
       */

      var client = contentful.createClient({
        space: '7o6w0tojuamk',
        accessToken: '53ad3a0c4575d14a4737ae6f2a5e42e521d5eed8a0860b5a488ffc135af5afa3'
      });

      /**
       * Loop through entries
       */

      var collection = {};

      var build = function(entries) {
        entries.items.map(function (entry) {
          var item = entry.fields;
          var content_type = entry.sys.contentType.sys.id;
          // Pop content type arrays
          if (!collection[content_type]) collection[content_type] = [];
          // Push new item
          collection[content_type].push(item);
        });
      };

      /**
       * Get data, then lay it on the screen with Handlebars
       */

      window.onload = function() {
        client.getEntries().then(
          function(entries) {
            build(entries);
          }
        ).then(function() {
          var source = document.querySelector('.wrapper').innerHTML;
          var template = Handlebars.compile(source);
          var html = template(collection);
          console.log(collection);
          document.querySelector('.container').innerHTML = html;
          document.querySelector('.container').style.opacity = 1;
        });
      };

    </script>

  </body>
</html>
